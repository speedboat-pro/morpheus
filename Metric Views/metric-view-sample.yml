version: 0.1
source: samples.tpch.orders

filter: o_orderdate > DATE'1997-01-01'

dimensions:
  - name: date
    expr: o_orderdate
  - name: year
    expr: DATE_TRUNC('year', o_orderdate)
  - name: Order Month
    expr: DATE_TRUNC('MONTH', o_orderdate)
  - name: Order Priority
    expr: SPLIT(o_orderpriority, '-')[1]
  - name: Order Date
    expr: o_orderdate
  - name: Market Segment
    expr: customer.c_mktsegment
  - name: Order Status Readable
    expr: >
      case 
        when o_orderstatus = 'O' then 'Open' 
        when o_orderstatus = 'P' then 'Processing' 
        when o_orderstatus = 'F' then 'Fulfilled' 
      end

measures:
  - name: YTD Sales
    expr: SUM(o_totalprice)
    window:
      - order: date
        range: cumulative
        semiadditive: last
      - order: year
        range: current
        semiadditive: last

  - name: Running Total Sales
    expr: SUM(o_totalprice)
    window:
      - order: date
        range: cumulative
        semiadditive: last        

  - name: Previous Day Sales
    expr: SUM(o_totalprice)
    window:
      - order: date
        range: trailing 1 day
        semiadditive: last

  - name: Current Day Sales
    expr: SUM(o_totalprice)
    window:
      - order: date
        range: current
        semiadditive: last

  - name: Day Over Day Growth
    expr: (MEASURE(`Current Day Sales`) - MEASURE(`Previous Day Sales`)) / MEASURE(`Previous Day Sales`) * 100   

  - name: Number of Customers - Last 7 Days
    expr: COUNT(DISTINCT o_custkey)
    window:
      - order: date
        range: trailing 7 day
        semiadditive: last         

  - name: Order Count
    expr: COUNT(1)

  - name: Total Revenue
    expr: SUM(o_totalprice)

  - name: Total Revenue per Customer
    expr: SUM(o_totalprice) / COUNT(DISTINCT o_custkey)

  - name: Total Revenue for Open Orders
    expr: SUM(o_totalprice) FILTER (WHERE o_orderstatus='O')

  - name: Number of Fulfilled Orders
    expr: COUNT(*) FILTER (WHERE `Order Status Readable` = 'Fulfilled')

  - name: Total Amount for Previous Month
    expr: SUM(o_totalprice)
    window:
     - order: Order Month
       range: trailing 1 month
       semiadditive: last

  - name: Total Amount for Current Month
    expr: SUM(o_totalprice)
    window:
     - order: Order Month
       range: current
       semiadditive: last
  
  - name: Change in Amount
    expr: MEASURE(`Total Amount for Current Month`) - MEASURE(`Total Amount for Previous Month`)    

  - name: AmountChangeStatus
    expr: >
      CASE
        WHEN MEASURE(`Change in Amount`) < 0 THEN 'Negative'
        ELSE 'Positive'
        END

joins:
 - name: customer
   source: samples.tpch.customer
   on: source.o_custkey = customer.c_custkey